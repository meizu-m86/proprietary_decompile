/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void sub_198C();
// int __fastcall _cxa_finalize(void *);
// int __fastcall _cxa_atexit(void (__fastcall *lpfunc)(void *), void *obj, void *lpdso_handle);
// int __fastcall android_atomic_acquire_load(_DWORD); weak
// int atrace_setup(void); weak
// ssize_t write(int fd, const void *buf, size_t n);
// int ioctl(int fd, unsigned int request, ...);
// int _android_log_print(_DWORD, _DWORD, const char *, ...); weak
// int __fastcall _errno(_DWORD); weak
// int usleep(__useconds_t useconds);
// _DWORD ExynosDisplay::getCompModeSwitch(ExynosDisplay *__hidden this); idb
// _DWORD ExynosExternalDisplay::getConfig(ExynosExternalDisplay *__hidden this); idb
// __pid_t getpid(void);
// int snprintf(char *s, size_t maxlen, const char *format, ...);
// int pthread_kill(pthread_t threadid, int signo);
// int pthread_join(pthread_t th, void **thread_return);
// int close(int fd);
// int pthread_mutex_unlock(pthread_mutex_t *mutex);
// int pthread_mutex_lock(pthread_mutex_t *mutex);
// _DWORD ExynosExternalDisplay::enable(ExynosExternalDisplay *__hidden this); idb
// _DWORD __fastcall ExynosExternalDisplay::isPresetSupported(ExynosExternalDisplay *__hidden this, unsigned int); idb
// _DWORD ExynosDisplayResourceManager::cleanupMPPs(ExynosDisplayResourceManager *__hidden this); idb
// _DWORD __fastcall ExynosExternalDisplay::setPreset(ExynosExternalDisplay *__hidden this, int); idb
// _DWORD android::String8::String8(android::String8 *__hidden this); idb
// _DWORD android::String8::appendFormat(android::String8 *__hidden this, const char *, ...); idb
// _DWORD __fastcall android::String8::append(android::String8 *__hidden this, const char *); idb
// int __fastcall strlcpy(_DWORD, _DWORD, _DWORD); weak
// void __fastcall android::String8::~String8(android::String8 *__hidden this); idb
// int open(const char *file, int oflag, ...);
// ssize_t read(int fd, void *buf, size_t nbytes);
// size_t strlen(const char *s);
// int strncmp(const char *s1, const char *s2, size_t n);
// int atoi(const char *nptr);
// __off_t lseek(int fd, __off_t offset, int whence);
// char *strerror(int errnum);
// unsigned __int64 strtoull(const char *nptr, char **endptr, int base);
// void *memset(void *s, int c, size_t n);
// int setpriority(__priority_which_t which, id_t who, int prio);
// int __fastcall uevent_init(_DWORD); weak
// int uevent_get_fd(void); weak
// int poll(struct pollfd *fds, nfds_t nfds, int timeout);
int __fastcall handle_vsync_event(int);
// int __fastcall uevent_next_event(_DWORD, _DWORD, _DWORD); weak
// int strcmp(const char *s1, const char *s2);
int __fastcall handle_hdmi_uevent(int a1, char *s, int a3);
int __fastcall handle_tui_uevent(int a1, char *s, int a3);
// int pthread_create(pthread_t *newthread, const pthread_attr_t *attr, void *(*start_routine)(void *), void *arg);
// __int64 __fastcall systemTime(_DWORD); weak
// _DWORD __fastcall ExynosExternalDisplay::setHdmiStatus(ExynosExternalDisplay *__hidden this, bool); idb
// int __fastcall ExynosVirtualDisplay::setPriContents(_DWORD, _DWORD); weak
int __fastcall exynos5_create_update_stat_thread(void *arg); // idb
// _DWORD ExynosExternalDisplay::disable(ExynosExternalDisplay *__hidden this); idb
// void *malloc(size_t size);
// _DWORD __fastcall operator new(unsigned int); idb
// int __fastcall ExynosPrimaryDisplay::ExynosPrimaryDisplay(_DWORD, _DWORD, _DWORD); weak
// int __fastcall ExynosExternalDisplayModule::ExynosExternalDisplayModule(_DWORD, _DWORD); weak
// int __fastcall ExynosVirtualDisplayModule::ExynosVirtualDisplayModule(_DWORD, _DWORD); weak
// int __fastcall hw_get_module(_DWORD, _DWORD); weak
// int __fastcall property_get(_DWORD, _DWORD, _DWORD); weak
// int __fastcall ExynosDisplayResourceManagerModule::ExynosDisplayResourceManagerModule(_DWORD, _DWORD); weak
// char *strncpy(char *dest, const char *src, size_t n);
// int __fastcall strlcat(_DWORD, _DWORD, _DWORD); weak
// int fstat(int fd, struct stat *buf);
// int __fastcall _strlen_chk(_DWORD, _DWORD); weak
// int __fastcall _strncpy_chk2(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD); weak
// _DWORD android::ExynosHWCService::getExynosHWCService(android::ExynosHWCService *__hidden this); idb
// int __fastcall android::ExynosHWCService::setPSRExitCallback(_DWORD, _DWORD); weak
// _DWORD android::WFDService::instantiate(android::WFDService *__hidden this); idb
// void free(void *ptr);
int __fastcall exynos5_hdmi_attribute(int, int);
int __fastcall exynos5_open(pthread_t a1, char *s1, pthread_t **a3);
int sub_1D00();
int (*__fastcall sub_1D20(int (*result)(void)))(void);
int __fastcall sub_1D4C(void *a1);
int __fastcall exynos5_registerProcs(int result, int a2);
int __fastcall exynos5_query(int a1, int a2, int *a3);
int sub_1DB4();
_QWORD *__fastcall sub_1DD8(__int64 a1);
int __fastcall exynos5_eventControl(int a1, int a2, int a3, int a4);
int __fastcall hwc_update_stat_thread(void *a1);
int __fastcall doPSRExit(int result, int a2, int a3);
int __fastcall exynos5_getDisplayConfigs(int a1, int a2, _DWORD *a3, _DWORD *a4);
ssize_t __fastcall sub_1F48(const char *a1);
int __fastcall exynos5_close(_DWORD *a1);
pthread_mutex_t **__fastcall sub_203A(pthread_mutex_t **a1);
int __fastcall sub_2048(pthread_mutex_t *a1);
pthread_mutex_t *__fastcall exynos5_set(int a1, pthread_mutex_t *a2, pthread_mutex_t *a3);
void __fastcall exynos5_dump(int a1, pthread_mutex_t *a2, pthread_mutex_t *a3);
int __fastcall exynos5_boot_finished(int a1, int a2, int a3);
int __fastcall handle_hdmi_uevent(int a1, char *s, int a3);
int __fastcall handle_tui_uevent(int a1, char *s, int a3);
int __fastcall handle_vsync_event(int a1);
int __fastcall hwc_vsync_thread(void *a1);
int __fastcall exynos5_create_update_stat_thread(void *arg); // idb
int __fastcall exynos5_prepare(int a1, pthread_mutex_t *a2, pthread_mutex_t *a3);
int __fastcall exynos5_blank(int a1, int a2, int a3);
int __fastcall exynos5_open(pthread_t a1, char *s1, pthread_t **a3);
int __fastcall exynos5_hdmi_attribute(int a1, int a2);
int exynos5_getDisplayAttributes(int, int, int, int, int); // weak
int j_atrace_setup();

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_2F28; // weak
_UNKNOWN unk_3B2C; // weak
_UNKNOWN unk_3B40; // weak
_UNKNOWN unk_3B54; // weak
_UNKNOWN unk_3B68; // weak
void *off_5000 = &off_5000; // weak
// extern _UNKNOWN atrace_is_ready; weak
// extern _QWORD atrace_enabled_tags; weak
// extern _UNKNOWN atrace_marker_fd; weak
// extern _UNKNOWN hwcDebug; weak


//----- (0000198C) --------------------------------------------------------
void sub_198C()
{
  JUMPOUT(0);
}
// 1998: control flows out of bounds to 0

//----- (00001B8C) --------------------------------------------------------
// attributes: thunk
int __fastcall handle_vsync_event(int a1)
{
  return _Z18handle_vsync_eventP31exynos5_hwc_composer_device_1_t(a1);
}

//----- (00001BB0) --------------------------------------------------------
// attributes: thunk
int __fastcall handle_hdmi_uevent(int a1, char *s, int a3)
{
  return _Z18handle_hdmi_ueventP31exynos5_hwc_composer_device_1_tPKci(a1, s, a3);
}

//----- (00001BBC) --------------------------------------------------------
// attributes: thunk
int __fastcall handle_tui_uevent(int a1, char *s, int a3)
{
  return _Z17handle_tui_ueventP31exynos5_hwc_composer_device_1_tPKci(a1, s, a3);
}

//----- (00001BF8) --------------------------------------------------------
// attributes: thunk
int __fastcall exynos5_create_update_stat_thread(void *arg)
{
  return _Z33exynos5_create_update_stat_threadP31exynos5_hwc_composer_device_1_t(arg);
}

//----- (00001CE8) --------------------------------------------------------
// attributes: thunk
int __fastcall exynos5_hdmi_attribute(int a1, int a2)
{
  return _Z22exynos5_hdmi_attributeP31exynos5_hwc_composer_device_1_tj(a1, a2);
}

//----- (00001CF4) --------------------------------------------------------
// attributes: thunk
int __fastcall exynos5_open(pthread_t a1, char *s1, pthread_t **a3)
{
  return _Z12exynos5_openPK11hw_module_tPKcPP11hw_device_t(a1, s1, a3);
}

//----- (00001D00) --------------------------------------------------------
int sub_1D00()
{
  return _cxa_finalize(&off_5000);
}
// 5000: using guessed type void *off_5000;

//----- (00001D20) --------------------------------------------------------
int (*__fastcall sub_1D20(int (*result)(void)))(void)
{
  if ( result )
    return (int (*)(void))result();
  return result;
}

//----- (00001D4C) --------------------------------------------------------
int __fastcall sub_1D4C(void *a1)
{
  return _cxa_atexit((void (__fastcall *)(void *))sub_1D20, a1, &off_5000);
}
// 5000: using guessed type void *off_5000;

//----- (00001D94) --------------------------------------------------------
int __fastcall exynos5_registerProcs(int result, int a2)
{
  *(_DWORD *)(result + 160) = a2;
  return result;
}

//----- (00001D9A) --------------------------------------------------------
int __fastcall exynos5_query(int a1, int a2, int *a3)
{
  int v3; // r0

  if ( !a2 )
  {
    v3 = 1;
    goto LABEL_5;
  }
  if ( a2 == 1 )
  {
    v3 = *(_DWORD *)(*(_DWORD *)(a1 + 116) + 28);
LABEL_5:
    *a3 = v3;
    return 0;
  }
  return -22;
}

//----- (00001DB4) --------------------------------------------------------
int sub_1DB4()
{
  int result; // r0

  result = android_atomic_acquire_load(&atrace_is_ready);
  if ( !result )
    return j_atrace_setup();
  return result;
}
// 19B8: using guessed type int __fastcall android_atomic_acquire_load(_DWORD);

//----- (00001DD8) --------------------------------------------------------
_QWORD *__fastcall sub_1DD8(__int64 a1)
{
  _QWORD *result; // r0
  char v3; // [sp+7h] [bp-11h] BYREF

  sub_1DB4();
  result = &atrace_enabled_tags;
  if ( (atrace_enabled_tags & a1) != 0 )
  {
    v3 = 69;
    return (_QWORD *)write(atrace_marker_fd, &v3, 1u);
  }
  return result;
}
// 50AC: using guessed type _QWORD atrace_enabled_tags;

//----- (00001E30) --------------------------------------------------------
int __fastcall exynos5_eventControl(int a1, int a2, int a3, int a4)
{
  _BOOL4 v4; // r3
  int v5; // r0
  int v6; // r0
  int v8; // [sp+4h] [bp-Ch] BYREF

  v8 = a2;
  if ( a3 )
    return -22;
  v4 = a4 != 0;
  *(_DWORD *)(a1 + 200) = v4;
  v5 = *(_DWORD *)(a1 + 116);
  v8 = v4;
  if ( ioctl(*(_DWORD *)(v5 + 4), 0x400446CEu, &v8) >= 0 )
    return 0;
  v6 = _android_log_print(6, "hwcomposer", "vsync ioctl failed");
  return -*(_DWORD *)_errno(v6);
}
// 19E8: using guessed type int __fastcall _android_log_print(_DWORD, _DWORD, _DWORD);
// 19F4: using guessed type int __fastcall _errno(_DWORD);

//----- (00001E84) --------------------------------------------------------
int __fastcall hwc_update_stat_thread(void *a1)
{
  int result; // r0
  int v3; // r5
  void (**v4)(void); // r0

  while ( 1 )
  {
    result = *((unsigned __int8 *)a1 + 244);
    if ( !*((_BYTE *)a1 + 244) )
      break;
    v3 = *((_DWORD *)a1 + 60);
    usleep(0x186A0u);
    if ( v3 == *((_DWORD *)a1 + 60) && ExynosDisplay::getCompModeSwitch(*((ExynosDisplay **)a1 + 29)) == 1 )
    {
      v4 = (void (**)(void))*((_DWORD *)a1 + 40);
      if ( v4 )
      {
        if ( *v4 )
          (*v4)();
      }
    }
  }
  return result;
}

//----- (00001EC8) --------------------------------------------------------
int __fastcall doPSRExit(int result, int a2, int a3)
{
  _DWORD v3[3]; // [sp+4h] [bp-Ch] BYREF

  v3[0] = a2;
  v3[1] = a3;
  if ( *(_DWORD *)(result + 156) )
  {
    if ( *(_BYTE *)(result + 290) )
    {
      *(_BYTE *)(result + 290) = 0;
      return ioctl(*(_DWORD *)(*(_DWORD *)(result + 116) + 4), 0x400446D2u, v3);
    }
  }
  return result;
}
// 1EC8: using guessed type _DWORD var_C[3];

//----- (00001EF4) --------------------------------------------------------
int __fastcall exynos5_getDisplayConfigs(int a1, int a2, _DWORD *a3, _DWORD *a4)
{
  int result; // r0

  if ( !*a4 )
    return 0;
  if ( !a2 )
  {
    *a3 = 0;
    *a4 = 1;
    return 0;
  }
  if ( a2 == 1 )
  {
    if ( *(_BYTE *)(a1 + 172) )
    {
      result = ExynosExternalDisplay::getConfig(*(ExynosExternalDisplay **)(a1 + 120));
      if ( !result )
      {
        *a3 = 0;
        *a4 = a2;
        return result;
      }
    }
    return -22;
  }
  if ( a2 != 2 )
    return -22;
  result = (*(int (__fastcall **)(_DWORD))(**(_DWORD **)(a1 + 124) + 116))(*(_DWORD *)(a1 + 124));
  if ( result )
    return -22;
  *a3 = 0;
  *a4 = 1;
  return result;
}

//----- (00001F48) --------------------------------------------------------
ssize_t __fastcall sub_1F48(const char *a1)
{
  ssize_t result; // r0
  __pid_t v3; // r0
  int v4; // r0
  char s[1024]; // [sp+Ch] [bp-414h] BYREF

  sub_1DB4();
  result = atrace_enabled_tags & 2;
  if ( (atrace_enabled_tags & 2) != 0 )
  {
    v3 = getpid();
    v4 = snprintf(s, 0x400u, "B|%d|%s", v3, a1);
    return write(atrace_marker_fd, s, v4);
  }
  return result;
}
// 50AC: using guessed type _QWORD atrace_enabled_tags;

//----- (00001FE0) --------------------------------------------------------
int __fastcall exynos5_close(_DWORD *a1)
{
  int v2; // r0

  pthread_kill(a1[41], 15);
  pthread_join(a1[41], 0);
  if ( pthread_kill(a1[59], 0) != 3 )
  {
    pthread_kill(a1[59], 15);
    pthread_join(a1[59], 0);
  }
  (*(void (**)(void))(*(_DWORD *)(a1[29] + 40) + 60))();
  close(a1[37]);
  v2 = a1[36];
  if ( v2 )
    (*(void (__fastcall **)(int))(*(_DWORD *)v2 + 4))(v2);
  return 0;
}

//----- (0000203A) --------------------------------------------------------
pthread_mutex_t **__fastcall sub_203A(pthread_mutex_t **a1)
{
  pthread_mutex_unlock(*a1);
  return a1;
}

//----- (00002048) --------------------------------------------------------
int __fastcall sub_2048(pthread_mutex_t *a1)
{
  return -pthread_mutex_lock(a1);
}

//----- (00002054) --------------------------------------------------------
pthread_mutex_t *__fastcall exynos5_set(int a1, pthread_mutex_t *a2, pthread_mutex_t *a3)
{
  pthread_mutex_t *v5; // r6
  int lock; // r5
  int count; // r7
  int owner; // r8
  ExynosExternalDisplay *v9; // r0
  int v10; // r0
  pthread_mutex_t *v12[9]; // [sp+4h] [bp-24h] BYREF

  v12[0] = a2;
  v12[1] = a3;
  v5 = a3;
  sub_1F48("exynos5_set");
  if ( a2 )
  {
    if ( v5 )
    {
      lock = v5->__lock;
      count = v5->__count;
      owner = v5->__owner;
      if ( v5->__lock )
      {
        v12[0] = (pthread_mutex_t *)(*(_DWORD *)(a1 + 116) + 48);
        sub_2048(v12[0]);
        v5 = (pthread_mutex_t *)(*(int (__fastcall **)(_DWORD, int))(**(_DWORD **)(a1 + 116) + 16))(
                                  *(_DWORD *)(a1 + 116),
                                  lock);
        sub_203A(v12);
      }
      else
      {
        v5 = 0;
      }
      if ( *(_DWORD *)(a1 + 188) != 3 && !*(_BYTE *)(a1 + 185) )
      {
        v9 = *(ExynosExternalDisplay **)(a1 + 120);
        *(_BYTE *)(a1 + 185) = 1;
        *(_BYTE *)(a1 + 172) = 1;
        ExynosExternalDisplay::enable(v9);
        v10 = *(_DWORD *)(a1 + 160);
        if ( v10 )
        {
          (*(void (__fastcall **)(int, int, int))(v10 + 8))(v10, 1, 1);
          (**(void (__fastcall ***)(_DWORD))(a1 + 160))(*(_DWORD *)(a1 + 160));
        }
      }
      if ( count )
      {
        if ( lock )
        {
          v12[0] = (pthread_mutex_t *)(*(_DWORD *)(a1 + 120) + 48);
          sub_2048(v12[0]);
          count = (*(int (__fastcall **)(_DWORD, int))(**(_DWORD **)(a1 + 120) + 16))(*(_DWORD *)(a1 + 120), count);
          sub_203A(v12);
        }
        else
        {
          count = 0;
        }
      }
      if ( *(_BYTE *)(a1 + 172)
        && *(_BYTE *)(a1 + 184)
        && !*(_DWORD *)(a1 + 188)
        && ExynosExternalDisplay::isPresetSupported(*(ExynosExternalDisplay **)(a1 + 120), *(_DWORD *)(a1 + 176)) )
      {
        ExynosExternalDisplay::setPreset(*(ExynosExternalDisplay **)(a1 + 120), *(_DWORD *)(a1 + 176));
      }
      if ( *(_DWORD *)(a1 + 188) == 3 )
        *(_DWORD *)(a1 + 188) = 0;
      if ( owner )
      {
        if ( lock )
          lock = (*(int (__fastcall **)(_DWORD, int))(**(_DWORD **)(a1 + 124) + 16))(*(_DWORD *)(a1 + 124), owner);
      }
      else
      {
        lock = 0;
      }
      *(_BYTE *)(a1 + 290) = 1;
      (*(void (__fastcall **)(_DWORD))(**(_DWORD **)(a1 + 116) + 24))(*(_DWORD *)(a1 + 116));
      ExynosDisplayResourceManager::cleanupMPPs(*(ExynosDisplayResourceManager **)(a1 + 144));
      if ( !v5 )
      {
        if ( count )
          v5 = (pthread_mutex_t *)count;
        else
          v5 = (pthread_mutex_t *)lock;
      }
    }
  }
  else
  {
    v5 = 0;
  }
  sub_1DD8(2LL);
  return v5;
}

//----- (00002188) --------------------------------------------------------
void __fastcall exynos5_dump(int a1, pthread_mutex_t *a2, pthread_mutex_t *a3)
{
  int v6; // r4
  int v7; // [sp+0h] [bp-28h] BYREF
  pthread_mutex_t *v8[9]; // [sp+4h] [bp-24h] BYREF

  v7 = a1;
  v8[0] = a2;
  v8[1] = a3;
  if ( (int)a3 > 0 )
  {
    android::String8::String8((android::String8 *)&v7);
    android::String8::appendFormat(
      (android::String8 *)&v7,
      "\n  hdmi_enabled=%u\n",
      *(unsigned __int8 *)(*(_DWORD *)(a1 + 120) + 1596));
    v6 = *(_DWORD *)(a1 + 120);
    if ( *(_BYTE *)(v6 + 1596) )
      android::String8::appendFormat(
        (android::String8 *)&v7,
        "    w=%u, h=%u\n",
        *(_DWORD *)(v6 + 12),
        *(_DWORD *)(v6 + 16));
    android::String8::append((android::String8 *)&v7, "Primary device's config information\n");
    (*(void (__fastcall **)(_DWORD, int *))(**(_DWORD **)(a1 + 116) + 20))(*(_DWORD *)(a1 + 116), &v7);
    if ( *(_BYTE *)(a1 + 172) )
    {
      android::String8::append((android::String8 *)&v7, "\n");
      android::String8::append((android::String8 *)&v7, "External device's config information\n");
      (*(void (__fastcall **)(_DWORD, int *))(**(_DWORD **)(a1 + 120) + 20))(*(_DWORD *)(a1 + 120), &v7);
    }
    v8[0] = (pthread_mutex_t *)(*(_DWORD *)(a1 + 116) + 48);
    sub_2048(v8[0]);
    android::String8::append((android::String8 *)&v7, "\n");
    android::String8::append((android::String8 *)&v7, "Primary device's layer information\n");
    (*(void (__fastcall **)(_DWORD, int *))(**(_DWORD **)(a1 + 116) + 32))(*(_DWORD *)(a1 + 116), &v7);
    sub_203A(v8);
    if ( *(_BYTE *)(a1 + 172) )
    {
      v8[0] = (pthread_mutex_t *)(*(_DWORD *)(a1 + 120) + 48);
      sub_2048(v8[0]);
      android::String8::append((android::String8 *)&v7, "\n");
      android::String8::append((android::String8 *)&v7, "External device's layer information\n");
      (*(void (__fastcall **)(_DWORD, int *))(**(_DWORD **)(a1 + 120) + 32))(*(_DWORD *)(a1 + 120), &v7);
      sub_203A(v8);
    }
    strlcpy(a2, v7, a3);
    android::String8::~String8((android::String8 *)&v7);
  }
}
// 1AD8: using guessed type int __fastcall strlcpy(_DWORD, _DWORD, _DWORD);

//----- (00002298) --------------------------------------------------------
int __fastcall exynos5_boot_finished(int a1, int a2, int a3)
{
  int result; // r0
  int v5; // r7
  int v6; // r0
  int v7; // r1
  int v8; // r2
  char buf; // [sp+7h] [bp-19h] BYREF
  int v10; // [sp+8h] [bp-18h]

  buf = HIBYTE(a2);
  v10 = a3;
  _android_log_print(3, "hwcomposer", "Boot Finished");
  if ( !a1 )
    return _android_log_print(
             6,
             "hwcomposer",
             "%s:: dev is NULL",
             "void exynos5_boot_finished(exynos5_hwc_composer_device_1_t*)");
  result = open("/sys/class/switch/hdmi/state", 0);
  v5 = result;
  if ( result >= 0 )
  {
    if ( read(result, &buf, 1u) == 1 && buf == 49 && !*(_BYTE *)(a1 + 172) )
    {
      *(_BYTE *)(a1 + 172) = 1;
      if ( (*(int (__fastcall **)(_DWORD))(**(_DWORD **)(a1 + 120) + 108))(*(_DWORD *)(a1 + 120)) > 0
        && ExynosExternalDisplay::getConfig(*(ExynosExternalDisplay **)(a1 + 120)) )
      {
        _android_log_print(6, "hwcomposer", "Error reading HDMI configuration");
        *(_BYTE *)(a1 + 172) = 0;
      }
      *(_BYTE *)(*(_DWORD *)(a1 + 120) + 1597) = 0;
      v6 = *(_DWORD *)(a1 + 160);
      if ( v6 )
      {
        (*(void (__fastcall **)(int, int, int))(v6 + 8))(v6, 1, 1);
        (**(void (__fastcall ***)(_DWORD, int, int))(a1 + 160))(*(_DWORD *)(a1 + 160), v7, v8);
      }
    }
    return close(v5);
  }
  return result;
}
// 2316: variable 'v7' is possibly undefined
// 2316: variable 'v8' is possibly undefined
// 19E8: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00002358) --------------------------------------------------------
int __fastcall handle_hdmi_uevent(int a1, char *s, int a3)
{
  char *v6; // r5
  int result; // r0

  v6 = &s[strlen(s) + 1];
  do
  {
    if ( !*v6 )
      break;
    if ( !strncmp(v6, "SWITCH_STATE=", 0xDu) )
      *(_BYTE *)(a1 + 172) = atoi(v6 + 13) == 1;
    v6 += strlen(v6) + 1;
  }
  while ( v6 - s < a3 );
  if ( *(_BYTE *)(a1 + 172) )
  {
    if ( (*(int (__fastcall **)(_DWORD))(**(_DWORD **)(a1 + 120) + 108))(*(_DWORD *)(a1 + 120)) > 0
      && ExynosExternalDisplay::getConfig(*(ExynosExternalDisplay **)(a1 + 120)) )
    {
      result = _android_log_print(6, "hwcomposer", "Error reading HDMI configuration");
      *(_BYTE *)(a1 + 172) = 0;
      return result;
    }
    *(_BYTE *)(*(_DWORD *)(a1 + 120) + 1597) = 0;
  }
  if ( *(_BYTE *)(a1 + 172) )
    _android_log_print(
      4,
      "hwcomposer",
      "HDMI Resolution changed to %dx%d",
      *(_DWORD *)(*(_DWORD *)(a1 + 120) + 12),
      *(_DWORD *)(*(_DWORD *)(a1 + 120) + 16));
  result = *(_DWORD *)(a1 + 160);
  if ( result )
    return (*(int (__fastcall **)(int, int, _DWORD))(result + 8))(result, 1, *(unsigned __int8 *)(a1 + 172));
  return result;
}
// 19E8: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00002428) --------------------------------------------------------
int __fastcall handle_tui_uevent(int a1, char *s, int a3)
{
  _BOOL4 v6; // r6
  char *v7; // r4
  int v8; // r4
  const char *v9; // r3
  int result; // r0

  v6 = 1;
  v7 = &s[strlen(s) + 1];
  do
  {
    if ( !*v7 )
      break;
    if ( !strncmp(v7, "SWITCH_STATE=", 0xDu) )
      v6 = atoi(v7 + 13) == 0;
    v7 += strlen(v7) + 1;
  }
  while ( v7 - s < a3 );
  if ( v6 )
  {
    v8 = 1;
    v9 = "disabled";
  }
  else
  {
    v8 = 0;
    v9 = "enabled";
  }
  _android_log_print(4, "hwcomposer", "TUI mode is %s", v9);
  result = *(_DWORD *)(a1 + 116);
  if ( *(unsigned __int8 *)(result + 1572) != v8 )
  {
    *(_BYTE *)(result + 1572) = v8;
    result = *(_DWORD *)(a1 + 160);
    if ( result )
    {
      if ( *(_DWORD *)result )
        return (*(int (**)(void))result)();
    }
  }
  return result;
}
// 19E8: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (000024C4) --------------------------------------------------------
int __fastcall handle_vsync_event(int a1)
{
  __off_t v2; // r0
  int *v3; // r0
  char *v4; // r3
  ssize_t v5; // r0
  int *v6; // r0
  char *v7; // r3
  _DWORD *v8; // r7
  char buf[4096]; // [sp+4h] [bp-101Ch] BYREF
  int v11; // [sp+1004h] [bp-1Ch]

  if ( *(_DWORD *)(a1 + 160) )
  {
    v2 = lseek(*(_DWORD *)(a1 + 148), 0, 0);
    if ( v2 >= 0 )
    {
      v5 = read(*(_DWORD *)(a1 + 148), buf, 0x1000u);
      if ( v5 >= 0 )
      {
        buf[4095] = 0;
        v8 = (_DWORD *)_errno(v5);
        *v8 = 0;
        strtoull(buf, 0, 0);
        if ( !*v8 )
          (*(void (**)(void))(*(_DWORD *)(a1 + 160) + 4))();
      }
      else
      {
        v6 = (int *)_errno(v5);
        v7 = strerror(*v6);
        _android_log_print(6, "hwcomposer", "error reading vsync timestamp: %s", v7);
      }
    }
    else
    {
      v3 = (int *)_errno(v2);
      v4 = strerror(*v3);
      _android_log_print(6, "hwcomposer", "error seeking to vsync timestamp: %s", v4);
    }
  }
  return v11;
}
// 19E8: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 19F4: using guessed type int __fastcall _errno(_DWORD);

//----- (000025A4) --------------------------------------------------------
int __fastcall hwc_vsync_thread(void *a1)
{
  int v2; // r0
  ssize_t v3; // r0
  int *v4; // r0
  char *v5; // r0
  int v6; // r2
  int v7; // r0
  int event; // r7
  int v9; // r0
  int *v10; // r0
  char *v11; // r0
  int v13; // [sp+4h] [bp-2044h]
  struct pollfd v14; // [sp+Ch] [bp-203Ch] BYREF
  int fd; // [sp+14h] [bp-2034h]
  __int16 v16; // [sp+18h] [bp-2030h]
  unsigned __int16 v17; // [sp+1Ah] [bp-202Eh]
  char v18[4096]; // [sp+1Ch] [bp-202Ch] BYREF
  int v19; // [sp+101Ch] [bp-102Ch] BYREF

  memset(v18, 0, sizeof(v18));
  v2 = setpriority(0, 0, -8);
  uevent_init(v2);
  v3 = read(*((_DWORD *)a1 + 37), &v19, 0x1000u);
  if ( v3 >= 0 )
  {
    v6 = *((_DWORD *)a1 + 37);
    v14.events = 2;
    v14.fd = v6;
    v16 = 1;
    fd = uevent_get_fd();
    while ( 1 )
    {
      do
      {
        while ( 1 )
        {
          v7 = poll(&v14, 2u, -1);
          if ( v7 <= 0 )
            break;
          if ( (v14.revents & 2) != 0 )
          {
            handle_vsync_event((int)a1);
          }
          else if ( (v17 & 1) != 0 )
          {
            event = uevent_next_event(v18, "hw_get_module", v17 << 31);
            v13 = strcmp(v18, "change@/devices/virtual/switch/hdmi");
            v9 = strcmp(v18, "change@/devices/virtual/switch/tui");
            if ( v13 )
            {
              if ( !v9 )
                handle_tui_uevent((int)a1, v18, event);
            }
            else
            {
              handle_hdmi_uevent((int)a1, v18, event);
            }
          }
        }
      }
      while ( v7 != -1 );
      v10 = (int *)_errno(0);
      if ( *v10 == 4 )
        break;
      v11 = strerror(*v10);
      _android_log_print(6, "hwcomposer", "error in vsync thread: %s", v11);
    }
  }
  else
  {
    v4 = (int *)_errno(v3);
    v5 = strerror(*v4);
    _android_log_print(6, "hwcomposer", "error reading vsync timestamp: %s", v5);
  }
  return 0;
}
// 19E8: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 19F4: using guessed type int __fastcall _errno(_DWORD);
// 1B68: using guessed type int __fastcall uevent_init(_DWORD);
// 1B74: using guessed type int uevent_get_fd(void);
// 1B98: using guessed type int __fastcall uevent_next_event(_DWORD, _DWORD, _DWORD);

//----- (0000271C) --------------------------------------------------------
int __fastcall exynos5_create_update_stat_thread(void *arg)
{
  int result; // r0
  char v3; // r3

  result = pthread_create((pthread_t *)arg + 59, 0, (void *(*)(void *))hwc_update_stat_thread, arg);
  if ( result )
  {
    result = _android_log_print(
               6,
               "hwcomposer",
               "%s: failed to start update_stat thread:",
               "void exynos5_create_update_stat_thread(exynos5_hwc_composer_device_1_t*)");
    v3 = 0;
  }
  else
  {
    v3 = 1;
  }
  *((_BYTE *)arg + 244) = v3;
  return result;
}
// 19E8: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00002768) --------------------------------------------------------
int __fastcall exynos5_prepare(int a1, pthread_mutex_t *a2, pthread_mutex_t *a3)
{
  int v6; // r2
  int v7; // r6
  int *v8; // r0
  int owner; // r6
  __int64 v10; // kr00_8
  int v11; // r3
  int v12; // r3
  char v13; // r1
  int v14; // r9
  int v15; // r8
  pthread_mutex_t *v17[9]; // [sp+4h] [bp-24h] BYREF

  v17[0] = a2;
  v17[1] = a3;
  sub_1F48("exynos5_prepare");
  if ( a2 && a3 )
  {
    v8 = *(int **)(a1 + 124);
    owner = a3->__owner;
    v10 = *(_QWORD *)&a3->__lock;
    v11 = *v8;
    if ( owner )
      (*(void (__fastcall **)(int *, int, _DWORD))(v11 + 120))(v8, a3->__owner, *(_DWORD *)(v11 + 120));
    else
      (*(void (__fastcall **)(int *, _DWORD, int))(v11 + 124))(v8, *(_DWORD *)(v11 + 124), v6);
    v12 = *(_DWORD *)(a1 + 232) + 1;
    ++*(_DWORD *)(a1 + 240);
    *(_DWORD *)(a1 + 232) = v12;
    *(_QWORD *)(a1 + 208) = systemTime(1);
    ExynosDisplay::getCompModeSwitch(*(ExynosDisplay **)(a1 + 116));
    v13 = *(_BYTE *)(a1 + 172);
    *(_DWORD *)(a1 + 224) = 0;
    *(_DWORD *)(a1 + 228) = 0;
    ExynosExternalDisplay::setHdmiStatus(*(ExynosExternalDisplay **)(a1 + 120), v13);
    if ( *(_DWORD *)(a1 + 256) == 1 && !*(_BYTE *)(a1 + 244) && !*(_BYTE *)(*(_DWORD *)(a1 + 116) + 32) )
      exynos5_create_update_stat_thread((void *)a1);
    (*(void (__fastcall **)(_DWORD, pthread_mutex_t *, pthread_mutex_t *))(**(_DWORD **)(a1 + 144) + 8))(
      *(_DWORD *)(a1 + 144),
      a2,
      a3);
    if ( (_DWORD)v10 )
    {
      v17[0] = (pthread_mutex_t *)(*(_DWORD *)(a1 + 116) + 48);
      sub_2048(v17[0]);
      v14 = (*(int (__fastcall **)(_DWORD, _DWORD))(**(_DWORD **)(a1 + 116) + 12))(*(_DWORD *)(a1 + 116), v10);
      if ( v14 )
      {
        sub_203A(v17);
        v7 = v14;
        goto LABEL_21;
      }
      sub_203A(v17);
    }
    if ( HIDWORD(v10) )
    {
      v17[0] = (pthread_mutex_t *)(*(_DWORD *)(a1 + 120) + 48);
      sub_2048(v17[0]);
      v15 = (*(int (__fastcall **)(_DWORD, _DWORD))(**(_DWORD **)(a1 + 120) + 12))(*(_DWORD *)(a1 + 120), HIDWORD(v10));
      if ( v15 )
      {
        sub_203A(v17);
        v7 = v15;
        goto LABEL_21;
      }
      sub_203A(v17);
    }
    if ( owner )
    {
      ExynosVirtualDisplay::setPriContents(*(_DWORD *)(a1 + 124), v10);
      v7 = (*(int (__fastcall **)(_DWORD, int))(**(_DWORD **)(a1 + 124) + 12))(*(_DWORD *)(a1 + 124), owner);
      goto LABEL_21;
    }
  }
  v7 = 0;
LABEL_21:
  sub_1DD8(2LL);
  return v7;
}
// 2798: variable 'v6' is possibly undefined
// 1BD4: using guessed type __int64 __fastcall systemTime(_DWORD);
// 1BEC: using guessed type int __fastcall ExynosVirtualDisplay::setPriContents(_DWORD, _DWORD);

//----- (000028A0) --------------------------------------------------------
int __fastcall exynos5_blank(int a1, int a2, int a3)
{
  int v6; // r7
  int v7; // r0
  char v8; // r6
  int v9; // r0
  int *v10; // r0
  int *v11; // r7
  ExynosExternalDisplay *v12; // r0
  int v13; // r4

  sub_1F48("exynos5_blank");
  _android_log_print(
    4,
    "hwcomposer",
    "%s:: disp(%d), blank(%d)",
    "int exynos5_blank(hwc_composer_device_1*, int, int)",
    a2,
    a3);
  if ( a2 )
  {
    if ( a2 != 1 )
    {
      v13 = -22;
      goto LABEL_30;
    }
    if ( *(_BYTE *)(a1 + 172) )
    {
      if ( a3 )
      {
        v12 = *(ExynosExternalDisplay **)(a1 + 120);
        if ( !*((_BYTE *)v12 + 1597) )
          ExynosExternalDisplay::disable(v12);
      }
      *(_BYTE *)(*(_DWORD *)(a1 + 120) + 1597) = a3 != 0;
    }
LABEL_28:
    v13 = 0;
    goto LABEL_30;
  }
  if ( a3 )
  {
    v7 = (*(int (__fastcall **)(_DWORD))(**(_DWORD **)(a1 + 116) + 40))(*(_DWORD *)(a1 + 116));
    if ( v7 >= 0 )
    {
      close(v7);
    }
    else if ( (hwcDebug & 1) != 0 )
    {
      _android_log_print(6, "hwcomposer", "error clearing primary display");
    }
    v6 = 4;
  }
  else
  {
    v6 = 0;
  }
  v8 = a3;
  if ( a3 )
    v8 = 1;
  *(_BYTE *)(*(_DWORD *)(a1 + 116) + 32) = v8;
  if ( pthread_kill(*(_DWORD *)(a1 + 236), 0) == 3 )
  {
    if ( !v6 && *(_DWORD *)(a1 + 256) == 1 )
      exynos5_create_update_stat_thread((void *)a1);
  }
  else if ( v6 == 4 )
  {
    *(_BYTE *)(a1 + 244) = 0;
  }
  v9 = ioctl(*(_DWORD *)(*(_DWORD *)(a1 + 116) + 4), 0x4611u, v6);
  if ( v9 >= 0 )
    goto LABEL_28;
  v10 = (int *)_errno(v9);
  v11 = v10;
  if ( *v10 == 16 )
  {
    _android_log_print(4, "hwcomposer", "%sblank ioctl failed (display already %sblanked)");
  }
  else
  {
    strerror(*v10);
    _android_log_print(6, "hwcomposer", "%sblank ioctl failed: %s");
  }
  v13 = -*v11;
LABEL_30:
  sub_1DD8(2LL);
  return v13;
}
// 19E8: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 19F4: using guessed type int __fastcall _errno(_DWORD);

//----- (00002A20) --------------------------------------------------------
int __fastcall exynos5_open(pthread_t a1, char *s1, pthread_t **a3)
{
  pthread_t *v3; // r7
  pthread_t v4; // r6
  pthread_t v5; // r4
  pthread_t v6; // r5
  pthread_t v7; // r1
  int v8; // r9
  int v9; // r6
  pthread_t v10; // r6
  int v11; // r0
  int *v12; // r4
  char *v13; // r3
  pthread_t v14; // r6
  char *v15; // r3
  int v16; // r0
  int v17; // r2
  int v18; // r10
  int v19; // r4
  unsigned __int64 v20; // r2
  int v21; // r0
  unsigned __int64 v22; // r2
  unsigned __int64 v23; // t0
  pthread_t v24; // r6
  pthread_t v25; // r3
  int v26; // r0
  pthread_t v27; // r8
  pthread_t v28; // r10
  int v29; // r1
  int v30; // r3
  int v31; // r5
  int v32; // r0
  int v33; // r0
  int v34; // r0
  int v35; // r0
  int v36; // r0
  int v37; // r0
  int ExynosHWCService; // r6
  android::WFDService *v39; // r0
  int v40; // r0
  int v41; // r6
  char *v42; // r0
  int v43; // r0
  unsigned int v44; // r0
  unsigned int v45; // r4
  int v46; // r0
  struct stat buf; // [sp+40h] [bp-298h] BYREF
  _DWORD v51[22]; // [sp+A8h] [bp-230h] BYREF
  unsigned int v52; // [sp+100h] [bp-1D8h]
  unsigned int v53; // [sp+104h] [bp-1D4h]
  unsigned int v54; // [sp+10Ch] [bp-1CCh]
  int v55; // [sp+110h] [bp-1C8h]
  int v56; // [sp+114h] [bp-1C4h]
  int v57; // [sp+118h] [bp-1C0h]
  int v58; // [sp+11Ch] [bp-1BCh]
  int v59; // [sp+138h] [bp-1A0h]
  int v60; // [sp+13Ch] [bp-19Ch]
  char v61[92]; // [sp+148h] [bp-190h] BYREF
  char dest[13]; // [sp+1A4h] [bp-134h] BYREF
  char v63; // [sp+1B1h] [bp-127h]
  char v64; // [sp+224h] [bp-B4h]
  char s[132]; // [sp+228h] [bp-B0h] BYREF

  if ( strcmp(s1, "composer") )
    return -22;
  v3 = (pthread_t *)malloc(0x130u);
  memset(v3, 0, 0x130u);
  v4 = operator new(0x638u);
  ExynosPrimaryDisplay::ExynosPrimaryDisplay(v4, 6, v3);
  v3[29] = v4;
  v5 = operator new(0x640u);
  ExynosExternalDisplayModule::ExynosExternalDisplayModule(v5, v3);
  v3[30] = v5;
  v6 = operator new(0x6C0u);
  ExynosVirtualDisplayModule::ExynosVirtualDisplayModule(v6, v3);
  v7 = v3[29];
  v3[31] = v6;
  if ( hw_get_module("gralloc", v7 + 44) )
  {
    _android_log_print(6, "hwcomposer", "failed to get gralloc hw module");
LABEL_6:
    v9 = -22;
LABEL_52:
    v8 = v9;
    free(v3);
    return v8;
  }
  v8 = (**(int (***)(void))(*(_DWORD *)(v3[29] + 44) + 20))();
  if ( v8 )
  {
    _android_log_print(6, "hwcomposer", "failed to open gralloc");
    goto LABEL_6;
  }
  *(_DWORD *)(v3[30] + 40) = *(_DWORD *)(v3[29] + 40);
  *(_DWORD *)(v3[31] + 40) = *(_DWORD *)(v3[29] + 40);
  v10 = v3[29];
  *(_DWORD *)(v10 + 4) = open("/dev/graphics/fb0", 2);
  v11 = *(_DWORD *)(v3[29] + 4);
  if ( v11 < 0 )
  {
    _android_log_print(6, "hwcomposer", "failed to open framebuffer");
    v9 = *(_DWORD *)(v3[29] + 4);
LABEL_51:
    (*(void (**)(void))(*(_DWORD *)(v3[29] + 40) + 60))();
    goto LABEL_52;
  }
  if ( ioctl(v11, 0x4600u, v51) == -1 )
  {
    v12 = (int *)_errno(0);
    v13 = strerror(*v12);
    _android_log_print(6, "hwcomposer", "FBIOGET_VSCREENINFO ioctl failed: %s", v13);
LABEL_15:
    v9 = -*v12;
LABEL_50:
    close(*(_DWORD *)(v3[29] + 4));
    goto LABEL_51;
  }
  if ( !v59 && !v60 )
  {
    v14 = v3[29];
    v59 = v51[0];
    v60 = v51[1];
    if ( ioctl(*(_DWORD *)(v14 + 4), 0x4601u, v51) == -1 )
    {
      v12 = (int *)_errno(0);
      v15 = strerror(*v12);
      _android_log_print(6, "hwcomposer", "FBIOPUT_VSCREENINFO ioctl failed: %s", v15);
      goto LABEL_15;
    }
  }
  property_get("debug.hwc.force_gpu", v61, "0");
  v16 = atoi(v61);
  v17 = v55;
  v3[42] = v16;
  v18 = v59;
  v19 = v60;
  v20 = (unsigned int)(v60 + v57 + v58)
      * (unsigned __int64)(unsigned int)(v56 + v59 + v17)
      * (unsigned int)vshrd_n_u64(vdup_n_s32(v54).n64_u64[0], 0x20u);
  v23 = loc_2F28 / v20;
  v22 = loc_2F28 % v20;
  v21 = v23;
  if ( !(_DWORD)v23 )
  {
    _android_log_print(5, "hwcomposer", "invalid refresh rate, assuming 60 Hz", HIDWORD(v22));
    v21 = 60;
  }
  *(_DWORD *)(v3[29] + 12) = v18;
  *(_DWORD *)(v3[29] + 16) = v19;
  *(_DWORD *)(v3[29] + 20) = (int)(float)((float)((float)((float)v18 * 25.4) * 1000.0) / (float)v53);
  *(_DWORD *)(v3[29] + 24) = (int)(float)((float)((float)((float)v19 * 25.4) * 1000.0) / (float)v52);
  *(_DWORD *)(v3[29] + 28) = 1000000000 / v21;
  _android_log_print(
    3,
    "hwcomposer",
    "using\n"
    "xres         = %d px\n"
    "yres         = %d px\n"
    "width        = %d mm (%f dpi)\n"
    "height       = %d mm (%f dpi)\n"
    "refresh rate = %d Hz\n",
    *(_DWORD *)(v3[29] + 12),
    *(_DWORD *)(v3[29] + 16),
    v53,
    (double)*(int *)(v3[29] + 20) / 1000.0,
    v52,
    (double)*(int *)(v3[29] + 24) / 1000.0,
    v21);
  v24 = operator new(0x30u);
  ExynosDisplayResourceManagerModule::ExynosDisplayResourceManagerModule(v24, v3);
  v25 = v3[29];
  v3[36] = v24;
  v26 = *(_DWORD *)(v25 + 12);
  v27 = v25 + 1524;
  v28 = v25 + 1544;
  v29 = *(_DWORD *)(v25 + 16);
  v30 = 0;
  if ( v29 * v26 <= 2073600 )
  {
    do
    {
      v32 = *(_DWORD *)((char *)&unk_3B54 + v30);
      *(_DWORD *)(v27 + v30) = *(_DWORD *)((char *)&unk_3B2C + v30);
      *(_DWORD *)(v28 + v30) = v32;
      v30 += 4;
    }
    while ( v30 != 20 );
  }
  else
  {
    do
    {
      v31 = *(_DWORD *)((char *)&unk_3B68 + v30);
      *(_DWORD *)(v27 + v30) = *(_DWORD *)((char *)&unk_3B40 + v30);
      *(_DWORD *)(v28 + v30) = v31;
      v30 += 4;
    }
    while ( v30 != 20 );
  }
  *(_DWORD *)(v3[29] + 1564) = 7;
  if ( (*(int (__fastcall **)(pthread_t))(*(_DWORD *)v3[30] + 108))(v3[30]) < 0 )
    _android_log_print(6, "hwcomposer", "openHdmi fail");
  v64 = 0;
  strncpy(dest, "/sys/devices/", 0x80u);
  strlcat(dest, "13930000.decon_fb/vsync", 128);
  v33 = open(dest, 0);
  v3[37] = v33;
  if ( v33 < 0 )
  {
    _android_log_print(4, "hwcomposer", "Failed to open vsync attribute at %s", dest);
    v63 = 0;
    strlcat(dest, "13a10000.sysmmu/13a00000.sysmmu/", 128);
    strlcat(dest, "13930000.decon_fb/vsync", 128);
    _android_log_print(4, "hwcomposer", "Retrying with %s", dest);
    v3[37] = open(dest, 0);
  }
  if ( (v3[37] & 0x80000000) != 0 )
  {
    strncpy(dest, "/sys/devices/", 0x80u);
    strlcat(dest, "exynos5-fb.1/vsync", 128);
    v34 = open(dest, 0);
    v3[37] = v34;
    if ( v34 < 0 )
    {
      _android_log_print(4, "hwcomposer", "Failed to open vsync attribute at %s", dest);
      v63 = 0;
      strlcat(dest, "platform/exynos-sysmmu.30/exynos-sysmmu.11/", 128);
      strlcat(dest, "exynos5-fb.1/vsync", 128);
      _android_log_print(4, "hwcomposer", "Retrying with %s", dest);
      v3[37] = open(dest, 0);
    }
  }
  v35 = v3[37];
  if ( v35 < 0 )
  {
    _android_log_print(6, "hwcomposer", "failed to open vsync attribute");
    v9 = v3[37];
    goto LABEL_48;
  }
  if ( fstat(v35, &buf) < 0 )
  {
    _android_log_print(6, "hwcomposer", "Failed to stat vsync node at %s", dest);
LABEL_35:
    v9 = 0;
LABEL_47:
    close(v3[37]);
LABEL_48:
    v46 = *(_DWORD *)(v3[30] + 4);
    if ( v46 > 0 )
      close(v46);
    goto LABEL_50;
  }
  if ( (buf.st_mode & 0xF000) != 0x8000 )
  {
    _android_log_print(6, "hwcomposer", "vsync node at %s should be a regualar file", dest);
    goto LABEL_35;
  }
  v3[38] = -1;
  memset(s, 0, 0x81u);
  v36 = _strlen_chk(dest, 129);
  _strncpy_chk2(s, dest, v36 - 5, 129, 129);
  strlcat(s, "psr_info", 128);
  _android_log_print(4, "hwcomposer", "PSR info devname = %s\n", s);
  v37 = open(s, 0);
  v3[38] = v37;
  if ( v37 >= 0 )
  {
    if ( read(v37, &buf, 1u) == 1 )
      v3[39] = atoi((const char *)&buf);
  }
  else
  {
    _android_log_print(5, "hwcomposer", "HWC needs to know whether LCD driver is using PSR mode or not\n");
  }
  _android_log_print(
    4,
    "hwcomposer",
    "PSR mode is %d(0: video mode, 1: DP PSR mode, 2: MIPI-DSI command mode)\n",
    v3[39]);
  v3[2] = a1;
  *v3 = 1213678676;
  v3[1] = 16973825;
  v3[15] = (pthread_t)exynos5_close;
  v3[16] = (pthread_t)exynos5_prepare;
  v3[17] = (pthread_t)exynos5_set;
  v3[18] = (pthread_t)exynos5_eventControl;
  v3[19] = (pthread_t)exynos5_blank;
  v3[20] = (pthread_t)exynos5_query;
  v3[21] = (pthread_t)exynos5_registerProcs;
  v3[22] = (pthread_t)exynos5_dump;
  v3[23] = (pthread_t)exynos5_getDisplayConfigs;
  v3[24] = (pthread_t)exynos5_getDisplayAttributes;
  *a3 = v3;
  ExynosHWCService = android::ExynosHWCService::getExynosHWCService((android::ExynosHWCService *)0xFFFFFFF0);
  (*(void (__fastcall **)(int, pthread_t *))(*(_DWORD *)ExynosHWCService + 156))(ExynosHWCService, v3);
  v39 = (android::WFDService *)android::ExynosHWCService::setPSRExitCallback(ExynosHWCService, doPSRExit);
  android::WFDService::instantiate(v39);
  *((_BYTE *)v3 + 185) = 1;
  v3[44] = 18;
  *((_BYTE *)v3 + 184) = 0;
  v3[47] = 0;
  v3[45] = 18;
  *((_BYTE *)v3 + 192) = 0;
  *((_BYTE *)v3 + 290) = 1;
  v40 = pthread_create(v3 + 41, 0, (void *(*)(void *))hwc_vsync_thread, v3);
  v41 = v40;
  if ( v40 )
  {
    v42 = strerror(v40);
    v9 = -v41;
    _android_log_print(6, "hwcomposer", "failed to start vsync thread: %s", v42);
    v43 = v3[38];
    if ( v43 > 0 )
      close(v43);
    goto LABEL_47;
  }
  v44 = v3[39];
  *((_BYTE *)v3 + 291) = 1;
  v3[65] = 1;
  v3[66] = 1;
  v3[62] = 7;
  v45 = 1 - v44;
  v3[63] = 2;
  if ( v44 > 1 )
    v45 = 0;
  v3[64] = v45;
  hwcDebug = 0;
  if ( v45 )
    exynos5_create_update_stat_thread(v3);
  return v8;
}
// 588: using guessed type Elf32_Sym;
// 19E8: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 19F4: using guessed type int __fastcall _errno(_DWORD);
// 1C28: using guessed type int __fastcall ExynosPrimaryDisplay::ExynosPrimaryDisplay(_DWORD, _DWORD, _DWORD);
// 1C34: using guessed type int __fastcall ExynosExternalDisplayModule::ExynosExternalDisplayModule(_DWORD, _DWORD);
// 1C40: using guessed type int __fastcall ExynosVirtualDisplayModule::ExynosVirtualDisplayModule(_DWORD, _DWORD);
// 1C4C: using guessed type int __fastcall hw_get_module(_DWORD, _DWORD);
// 1C58: using guessed type int __fastcall property_get(_DWORD, _DWORD, _DWORD);
// 1C70: using guessed type int __fastcall ExynosDisplayResourceManagerModule::ExynosDisplayResourceManagerModule(_DWORD, _DWORD);
// 1C88: using guessed type int __fastcall strlcat(_DWORD, _DWORD, _DWORD);
// 1CA0: using guessed type int __fastcall _strlen_chk(_DWORD, _DWORD);
// 1CAC: using guessed type int __fastcall _strncpy_chk2(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 1CC4: using guessed type int __fastcall android::ExynosHWCService::setPSRExitCallback(_DWORD, _DWORD);
// 2054: using guessed type int exynos5_set();
// 2188: using guessed type int exynos5_dump();
// 2768: using guessed type int exynos5_prepare();
// 28A0: using guessed type int exynos5_blank();
// 3218: using guessed type int exynos5_getDisplayAttributes(int, int, int, int, int);
// 2A20: using guessed type _DWORD var_230[22];

//----- (000031D0) --------------------------------------------------------
int __fastcall exynos5_hdmi_attribute(int a1, int a2)
{
  int result; // r0

  switch ( a2 )
  {
    case 1:
      result = *(_DWORD *)(*(_DWORD *)(a1 + 116) + 28);
      break;
    case 2:
      result = *(_DWORD *)(*(_DWORD *)(a1 + 120) + 12);
      break;
    case 3:
      result = *(_DWORD *)(*(_DWORD *)(a1 + 120) + 16);
      break;
    case 4:
    case 5:
      result = 0;
      break;
    default:
      _android_log_print(6, "hwcomposer", "unknown display attribute %u", a2);
      result = -22;
      break;
  }
  return result;
}
// 19E8: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00003218) --------------------------------------------------------
int __fastcall exynos5_getDisplayAttributes(int a1, int a2, int a3, int a4, int a5)
{
  int i; // r4
  int v9; // r1
  int v10; // r0
  int v11; // r0

  for ( i = 0; ; i += 4 )
  {
    v9 = *(_DWORD *)(a4 + i);
    if ( !v9 )
      break;
    if ( a2 )
    {
      if ( a2 == 1 )
      {
        v11 = exynos5_hdmi_attribute(a1, v9);
        goto LABEL_10;
      }
      if ( a2 != 2 )
      {
        _android_log_print(6, "hwcomposer", "unknown display type %u", a2);
        return -22;
      }
      v10 = *(_DWORD *)(a1 + 124);
    }
    else
    {
      v10 = *(_DWORD *)(a1 + 116);
    }
    v11 = (*(int (__fastcall **)(int))(*(_DWORD *)v10 + 44))(v10);
LABEL_10:
    *(_DWORD *)(a5 + i) = v11;
  }
  return 0;
}
// 19E8: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 3218: using guessed type int exynos5_getDisplayAttributes(int, int, int, int, int);

//----- (00003278) --------------------------------------------------------
// attributes: thunk
int j_atrace_setup()
{
  return atrace_setup();
}
// 19C4: using guessed type int atrace_setup(void);

// nfuncs=170 queued=36 decompiled=36 lumina nreq=0 worse=0 better=0
// ALL OK, 36 function(s) have been successfully decompiled
